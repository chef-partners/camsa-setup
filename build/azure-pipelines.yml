name: 0.0$(Rev:.r)

stages:
- stage: Build
  displayName: Build Stage
  variables:
    MANAGED_APP: true
    AUTOMATE_DOWNLOAD_CHANNEL: acceptance
    CAMSA_FIRSTNAME: Azure
    CAMSA_LASTNAME: DevOps
    CAMSA_USERNAME: azdo
    CHEF_ORG: camsa
    CHEF_ORG_DESCRIPTION: CAMSA
    
  jobs:
  - job: Build
    displayName: Built CAMSA Effortless Package
    pool:
      name: AMA Agent
    steps:
    - task: vsts-chef-task-test-kitchen@1
      displayName: Tests CAMSA Cookbook
      inputs:
        tkAzureEndpoint: CAMSA AzDo Azure SPN
        tkCommand: test
        tkKitchenFile: kitchen.yml
        
    - task: vsts-habitat-install@3
      displayName: Install Habitat

    - task: vsts-habitat-signing-key@3
      displayName: Signing Origin Key
      inputs:
        habitatOrigin: CAMSA Origin
        taskAction: install

    - task: vsts-habitat-build@3
      displayName: Build Habitat plan
      inputs:
        habitatOrigin: CAMSA Origin
        habitatSrcPath: '$(Build.SourcesDirectory)'
        habitatPlanContext: 'habitat'

    - task: vsts-habitat-expose-habitat-build-vars@3
      displayName: 'Expose Habitat Build Variables'
      inputs:
        habitatLastBuildEnvPath: '$(Build.SourcesDirectory)/results'
        habitatSetImageNames: true
        habitatImageNamesFilename: '$(System.DefaultWorkingDirectory)/image.names'

    - task: vsts-habitat-pkg-upload@3
      displayName: Upload CAMSA Package
      inputs:
        habitatOrigin: CAMSA Origin    
        habitatPackagePath: '$(Build.SourcesDirectory)/results/$(pkg_artifact)'      

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/results'
        Contents: |
          *-$(Build.BuildNumber)-*.hart
          last_build.env
        TargetFolder: '$(build.artifactstagingdirectory)'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
