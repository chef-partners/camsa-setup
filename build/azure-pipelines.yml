name: 0.0$(Rev:.r)

stages:
- stage: Build
  displayName: Build Stage
  variables:
    MANAGED_APP: true
    AUTOMATE_DOWNLOAD_CHANNEL: acceptance
    CAMSA_FIRSTNAME: Azure
    CAMSA_LASTNAME: DevOps
    CAMSA_USERNAME: azdo
    CHEF_ORG: camsa
    CHEF_ORG_DESCRIPTION: CAMSA
    CHEF_LICENSE: accept
    AZURE_LOCATION: uksouth
    RG_NAME: azdo-camsa-setup-$(Build.BuildNumber)
    
  jobs:
  - job: Build
    displayName: Built CAMSA Effortless Package
    pool:
      name: Hosted Ubuntu 1604
    steps:

    - task: AzureResourceGroupDeployment@2
      displayName: Deploy CAMSA Functions
      inputs:
        azureSubscription: 'CAMSA AzDo Azure SPN'
        action: 'Create Or Update Resource Group'
        resourceGroupName: $(RG_NAME)
        location: $(AZURE_LOCATION)
        templateLocation: 'Linked artifact'
        csmFile: $(Build.SourcesDirectory)/build/azuredeploy.json
        deploymentMode: 'Incremental'
        overrideParameters: -prefix azdo -repoBranch master

    - task: ARM Outputs@5
      displayName: Retrieve ARM Deployment Outputs
      inputs:
        ConnectedServiceNameSelector: 'ConnectedServiceNameARM'
        ConnectedServiceNameARM: 'CAMSA AzDo Azure SPN'
        resourceGroupName: $(RG_NAME)
        whenLastDeploymentIsFailed: 'fail'
        prefix: azdo_

    - task: vsts-chef-task-install-chefdk@1
      displayName: Install ChefDK

    - task: CmdLine@2
      inputs:
        script: sudo /opt/chefdk/embedded/bin/gem cleanup bundler
          
    - task: vsts-chef-task-test-kitchen@1
      displayName: Tests CAMSA Cookbook
      enabled: false
      inputs:
        tkAzureEndpoint: CAMSA AzDo Azure SPN
        tkCommand: test
        tkKitchenFile: kitchen.yml

    - task: AzureResourceGroupDeployment@2
      inputs:
        azureSubscription: 'CAMSA AzDo Azure SPN'
        action: 'DeleteRG'
        resourceGroupName: $(RG_NAME)        

    - task: PublishTestResults@2
      enabled: false
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'test/*_inspec.xml'
        testRunTitle: 'Test Kitchen Tests'

    - task: vsts-habitat-install@3
      displayName: Install Habitat

    - task: vsts-habitat-signing-key@3
      displayName: Signing Origin Key
      inputs:
        habitatOrigin: CAMSA Origin
        taskAction: install

    - task: vsts-habitat-build@3
      displayName: Build Habitat plan
      inputs:
        habitatOrigin: CAMSA Origin
        habitatSrcPath: '$(Build.SourcesDirectory)'
        habitatPlanContext: 'habitat'

    - task: vsts-habitat-expose-habitat-build-vars@3
      displayName: 'Expose Habitat Build Variables'
      inputs:
        habitatLastBuildEnvPath: '$(Build.SourcesDirectory)/results/last_build.env'
        habitatSetImageNames: true
        habitatImageNamesFilename: '$(System.DefaultWorkingDirectory)/image.names'

    - task: vsts-habitat-pkg-upload@3
      displayName: Upload CAMSA Package
      inputs:
        habitatOrigin: CAMSA Origin    
        habitatPackagePath: '$(Build.SourcesDirectory)/results/$(pkg_artifact)'      

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/results'
        Contents: |
          *-$(Build.BuildNumber)-*.hart
          last_build.env
        TargetFolder: '$(build.artifactstagingdirectory)'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'

