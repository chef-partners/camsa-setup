<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  
    <title>Recipes - CAMSA Setup</title>

    <link rel="stylesheet" href="http://localhost:4000/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/customstyles.css">

    
  

  <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css">

  

  
    <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Recipes | CAMSA Setup</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Recipes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Setup cookbooks for the CAMSA solution" />
<meta property="og:description" content="Setup cookbooks for the CAMSA solution" />
<link rel="canonical" href="http://localhost:4000/docs/cookbooks/camsa/recipes/" />
<meta property="og:url" content="http://localhost:4000/docs/cookbooks/camsa/recipes/" />
<meta property="og:site_name" content="CAMSA Setup" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/docs/cookbooks/camsa/recipes/","headline":"Recipes","description":"Setup cookbooks for the CAMSA solution","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>

  <div class="page-wrap">
    <div class="side-bar">
      <a href="http://localhost:4000/" class="site-title fs-6 lh-tight">CAMSA Setup</a>
      <span class="fs-3"><button class="js-main-nav-trigger navigation-list-toggle btn btn-outline" type="button" data-text-toggle="Hide">Menu</button></span>
      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list">
    
    
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/" class="navigation-list-link">Overview</a>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/cookbooks/cookbooks/" class="navigation-list-link">Cookbooks</a>
            
              
              <ul class="navigation-list-child-list ">
                
                  
                
                  
                
                  
                
                  
                
                  
                    <li class="navigation-list-item  active">
                      
                      <a href="http://localhost:4000/docs/cookbooks/camsa/description/" class="navigation-list-link">camsa</a>
                      
                        
                        <ul class="navigation-list-child-list">
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                              <li class="navigation-list-item ">
                                <a href="http://localhost:4000/docs/cookbooks/camsa/attributes/" class="navigation-list-link">Attributes</a>
                              </li>
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                              <li class="navigation-list-item ">
                                <a href="http://localhost:4000/docs/cookbooks/camsa/libraries/description/" class="navigation-list-link">Libraries</a>
                              </li>
                            
                          
                            
                          
                            
                              <li class="navigation-list-item  active">
                                <a href="http://localhost:4000/docs/cookbooks/camsa/recipes/" class="navigation-list-link active">Recipes</a>
                              </li>
                            
                          
                            
                          
                            
                              <li class="navigation-list-item ">
                                <a href="http://localhost:4000/docs/cookbooks/camsa/resources/description/" class="navigation-list-link">Resources</a>
                              </li>
                            
                          
                            
                          
                            
                          
                            
                              <li class="navigation-list-item ">
                                <a href="http://localhost:4000/docs/cookbooks/camsa/templates/description/" class="navigation-list-link">Templates</a>
                              </li>
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                            
                          
                        </ul>
                      
                    </li>
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
              </ul>
            
          </li>
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/policyfiles/description/" class="navigation-list-link">Policy Files</a>
            
              
              <ul class="navigation-list-child-list ">
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/policyfiles/server_setup/" class="navigation-list-link">server_setup</a>
                      
                    </li>
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
              </ul>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/glossary" class="navigation-list-link">Glossary of Terms</a>
            
          </li>
        
      
    
  </ul>
</nav>

      </div>
      <footer role="contentinfo" class="site-footer">
        <p class="text-small text-grey-dk-000 mb-0">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap js-main-content" tabindex="0">
      <div class="page-header">
        <div class="main-content">
          
          <div class="search js-search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search CAMSA Setup" aria-label="Search CAMSA Setup" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
            <ul class="list-style-none text-small mt-md-1 mb-md-1 pb-4 pb-md-0 js-aux-nav aux-nav">
              
                <li class="d-inline-block my-0"><a href="//github.com/chef-partners/camsa-setup">CAMSA Setup</a></li>
              
            </ul>
          
        </div>
      </div>
      <div class="main-content">
        
          
            <nav class="breadcrumb-nav">
              <ol class="breadcrumb-nav-list">
                
                  <li class="breadcrumb-nav-list-item"><a href="">camsa</a></li>
                
                <li class="breadcrumb-nav-list-item"><span>Recipes</span></li>
              </ol>
            </nav>
          
        
        <div id="main-content" class="page-content" role="main">
          <h1 id="recipes">Recipes</h1>

<p>A number of recipes exist in the cookbook that are used to configure the components of CAMSA.</p>

<h2 id="backup">backup</h2>

<p>Configure the backup script on the servers. It will write out the backup script to disk and then set it as a cronjob to be run each night.</p>

<p>When the cronjob is added the type of backup is passed in, e.g. <code class="highlighter-rouge">-t automate</code>. This is determined based on the attributes that are set for <code class="highlighter-rouge">node['camsa']['deploy']</code>.</p>

<h2 id="certificate">certificate</h2>

<p>Configures the SSL certificates for the Automate server.</p>

<p>When the recipe is called the resource that is used will install the <code class="highlighter-rouge">certbot</code> command which is used to obtain ceritficates from Lets Encrypt.</p>

<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle"></i> <b>Warning:</b> Currently it is not possible to set the certificates for the Chef Server if it is deployed separately to the Automate server</div>

<h2 id="clean">clean</h2>

<p>In order to test the recipes and cookbooks correctly it is often necessary to remove any flag files are that are in <code class="highlighter-rouge">/usr/local/camsa/flags</code>. This recipe will remove all of these flags so that the recipes run as if they have not been run before.</p>

<p>This recipe is in the Policy File run list and is controlled by the <code class="highlighter-rouge">node['camsa']['clean']</code> attribute.</p>

<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle"></i> <b>Warning:</b> This <strong>must</strong> not be used in production. It is intended to be used in development with Test Kitchen</div>

<h2 id="config_store">config_store</h2>

<p>Store machine information in the configuration store. For every machine that runs this recipe the following information will be uploaded:</p>

<ul>
  <li>Internal IP Address</li>
  <li>FQDN assigned to the machine</li>
  <li>FQDN of the Public IP Address assigned to the machine</li>
</ul>

<h2 id="datadisks">datadisks</h2>

<p>Format and mount the data disk on the machine.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> For the moment this only runs on machines where Automate is being deployed</div>

<h2 id="directories">directories</h2>

<p>Create the directories for CAMSA as defined in the <a href="/docs/cookbooks/camsa/attributes/#directories.rb">directories</a> attributes.</p>

<h2 id="dns">dns</h2>

<p>If the deployment is running as a managed application register the machine with the <code class="highlighter-rouge">managedautomate.io</code> DNS zone.</p>

<p>The recipe calls the <a href="/docs/cookbooks/camsa/libraries/automate_dns/"><code class="highlighter-rouge">automate_dns</code></a> resource which verifies the Azure subscription ID and Automate license and if they pass the server will be added to the DNS zone.</p>

<h2 id="install">install</h2>

<p>This recipe determines what to install based on the <code class="highlighter-rouge">node['camsa']['deploy']</code> attribute.</p>

<p>For the Chef and Automate servers the Automate package is installed from the <code class="highlighter-rouge">acceptance</code> channel (until it becomes stable). The chef server is installed using the <code class="highlighter-rouge">--product</code> switch to the <code class="highlighter-rouge">chef-automate-ctl</code> command.</p>

<p>This recipe will also be responsible for installing the Chef supermarket, which is currently not being deployed yet.</p>

<h2 id="kernel">kernel</h2>

<p>Automate requires some specific kernel settings, this recipe sets these values on the server.</p>

<h2 id="license">license</h2>

<p>In order operate an Automate server it must ben licensed, either a trial or a full one. This recipe will determine if a full license has been supplied and apply it if it has. However if not a trial license will be obtained and applied to the instance.</p>

<p>The license is made available to other recipes and resources through <code class="highlighter-rouge">node.run_state</code>.</p>

<h2 id="monitoring">monitoring</h2>

<p>Configures the monitoring for the deployed components.</p>

<p>Depending on what is being deployed (denoted by <code class="highlighter-rouge">node['camsa]['deploy']</code>) the monitoring solution will be installed. For example if deploying Chef then Statsd will be installed and the necessary plugin written out.</p>

<h2 id="tokens">tokens</h2>

<p>Creates tokens in the Automate server for API access.</p>

<p>Any tokens that are create are uploaded to the configuration store.</p>

<p>As there is no way to detect if a token has already been created on the server, flag file is created in <code class="highlighter-rouge">/usr/local/camsa/flags</code> for the named token. If the file exist the resource will not be executed.</p>

<h2 id="user">user</h2>

<p>Create the specified user in the Chef and Automate servers.</p>

<p>The user that was specified will be created in both components. With respect to the Chef server the organisation will also be created.</p>

<h2 id="whitelist">whitelist</h2>

<p>In order to be able to log to the managed app Log Analytics the workspace and key need to be sought. As these are not embedded into the files in source control, they have to be obtained from the central functions.</p>

<p>When the function is called, the subscription id and the Automate license are passed. If the subscription is whitelisted, e.g. permitted to log, the automate license will be verified. If this passes the function will return the Log Analytics workspace information.</p>


          
        </div>
      </div>
    </div>
  </div>

</body>
</html>
